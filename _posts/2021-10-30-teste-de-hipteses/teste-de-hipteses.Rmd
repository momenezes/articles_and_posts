---
title: "Teste de Hipótese"
description: |
  Conceitos, cálculos e visualizações.
author:
  - name: Mario O. de Menezes
    url: https://momenezes.github.io/tutorials
    orcid_id: 0000-0003-0263-3541
date: 10-30-2021
output:
  distill::distill_article:
    self_contained: false
    highlight: tango
draft: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(tidyverse)
library(plotly)
library(ggpubr)
```


# Teste de Hipótese

## População e Amostra

Muitas vezes precisamos obter medidas de a uma *população* (todos os indivíduos de interesse do estudo); o modo inicial para se fazer isso seria obter os dados de toda a população. Mas nem sempre é possível realizar essa coleta de dados de toda a população, e isso por diversos motivos, dentre eles o custo e o tempo necessário.

Assim, é comum utilizarmos um subconjunto da população, chamado de *amostra*. Essa *amostra* deve possuir então características que nos possibilitem *inferir* os parâmetros da população. Há diversas maneiras de se selecionar os elementos da *amostra*: aleatoriamente, por grupos representativos, por representatividade na população, etc. Esses conceitos podem ser explorados em um bom livro de Estatística e Probabilidade.

A maneira mais utilizada de se selecionar os indivíduos da amostra é a aleatória, de forma independente, cuidando para que cada elemento tenha a mesma probabilidade de ser selecionado, isto é, identicamente distribuído. Uma outra característica da amostra é o seu tamanho, que será o conceito que exploraremos nesse estudo juntamente com uma característica da população, a saber, o desvio padrão.

Então, com a amostra em mãos, efetuamos os cálculos desejados e fazemos a *inferência*, isto é, uma afirmação sobre um *parâmetro* da população. Nossa afirmação pode estar correta (ser verdadeira) ou errada (ser falsa). É comum querermos atribuir um grau de confiança a esta afirmação; algo como "... é possível afirmar, com 95% de confiança, que ..."

Juntando estes conceitos, chegamos à definição (informal) de Teste de Hipótese:

> Um teste de hipótese em Estatística é uma afirmação sobre um parâmetro de uma população a partir dos dados de uma amostra.

## Distribuição de Probabilidade

Suponha que você esteja estudando o peso (massa corporal) de uma população de animais que vive em determinada região. Em um trabalho muito extenso anterior, todos os animais daquela população foram pesados, de modo que são conhecidos para a população o peso médio ( $\mathbf{\mu}$) e também a dispersão destes valores, isto é, o desvio padrão ($\mathbf{\sigma}$).

Ao *plotar* os valores do peso de cada animal e também através de algumas verificações matemáticas, conclui-se que a variável aleatória peso segue uma distribuição normal. *Variável aleatória* porque cada animal tem um peso diferente, que não tem dependência com o animal que foi pesado antes e nem vai influenciar o peso do próximo animal. 

No Teste de Hipótese, um conceito importante é *a distribuição de probabilidades* da variável aleatória que estamos estudando. É preciso conhecer essa distribuição de probabilidades; caso não seja possível esse conhecimento, será necessário fazer assunções sobre ela para realizar o teste.

```{r}
set.seed(1234)
media = 3.4
desvio = 0.7
tam = 8000
y <- rnorm(tam, mean = media, sd = desvio)
x <- seq(1:tam)
df <- tibble(x = x, `Peso(kg)` = y)
```

A distribuição normal é aquela com forma de *sino*; se adotarmos no nosso exemplo que a média de peso da população seja 3.4kg, com um desvio padrão 0.7kg, e a população que foi pesada seja de `r tam` animais, podemos ter uma *ideia* da distribuição real de probabilidades dos pesos como a mostrada na figura abaixo. Como nossa população é finita, a curva mostrada é uma estimativa da curva de densidade de probabilidade e o formato da curva não é perfeitamente um *sino*, mas se aproxima. O histograma da distribuição de pesos também é mostrado nessa figura.

```{r}
g <- ggplot(data = df, aes(x = `Peso(kg)`, after_stat(density))) + 
  geom_density(outline.type = "full") + 
  geom_histogram(alpha = 0.3 ) +
  labs(x = "Peso(kg)", y = "Densid.Prob.") +
  theme_light() 
ggplotly(g + ggtitle(paste("Distribuição dos pesos da população (n=",tam,")")))
```



O eixo *y* representa a *estimativa da densidade de probabilidade de ocorrência de x*, que é calculada de tal forma que a área sob a curva seja 1. Você pode ler mais sobre Estimativa de Densidade de Probabilidade [aqui](https://bookdown.org/egarpor/PM-UC3M/npreg-npdens.html).


<!-- algumas outras referencias sobre estimativa de densidade de probabilidade: 
https://vita.had.co.nz/papers/density-estimation.pdf
https://myweb.uiowa.edu/pbreheny/uk/teaching/621/notes/10-18.pdf
https://www.r-bloggers.com/2013/06/exploratory-data-analysis-kernel-density-estimation-in-r-on-ozone-pollution-data-in-new-york-and-ozonopolis/
https://cran.r-project.org/web/packages/kdensity/vignettes/tutorial.html
https://github.com/admond1994/calculate-probability-from-probability-density-plots/blob/master/cal_probability.ipynb
-->
<!--
Ao mover o mouse sobre os pontos, os valores de *x* e *y* são mostrados; você poderá verificar que quando se afasta da média *x = 3.4*, o valor de *y* vai ficando cada vez menor, isto é, a probabilidade de ocorrência deste valor de *x* vai ficando cada vez menor.
-->

## Amostras

Suponha que nosso biólogo colete uma amostra dos animais e faça a pesagem. Do ponto de vista da Teoria da Probabilidade, temos a seguinte definição:

> Se a população da qual se extraem as amostras tem distribuição normal, então a distribuição de probabilidade da média amostral também seguirá uma normal.

Podemos simular um experimento que realize um grande número de amostragens, calcule a média de cada amostra e depois observamos a distribuição destas médias amostrais. 

Começamos com a ilustração de uma amostra de $n = 30$ dos animais em estudo, conforme mostrado na figura abaixo, onde os pontos de cor azul representam a amostra.

```{r}
set.seed(1234)
n = 30
amostra <- slice_sample(df, n = n, replace = TRUE)
amostra$P0 <- 0
pesomedioamostra = mean(amostra$`Peso(kg)`)
g + geom_point(aes(x = `Peso(kg)`, y = P0), data = amostra, color = "blue") +
  geom_segment(aes(x = pesomedioamostra, y = 0, xend=pesomedioamostra, yend = 0.05), color = "red") +
  annotate("text", x = 1.0*pesomedioamostra, y = 0.07, label = paste("Méd.Am. ",  round(pesomedioamostra,2)), size = 3) +
  ggtitle(paste("Experimento com uma amostra de tamanho = ",n))
```


```{r}
set.seed(1234)

geragrafs <- function(g, amostra) {
  amostra$P0 <- 0
  pesomedioamostra = mean(amostra$`Peso(kg)`)
  novog <- g + geom_point(aes(x = `Peso(kg)`, y = P0), data = amostra, color = "blue") +
               geom_segment(aes(x = pesomedioamostra, y = 0, xend=pesomedioamostra, yend = 0.05), 
                            color = "red") +
               annotate("text", x = 1.0*pesomedioamostra, y = 0.08, 
                        label = paste("Méd.Am.: ",  round(pesomedioamostra,3)), size = 3)
}

geraamostras <- function(df, qts, N){
  amostras <- list()
  for (I in seq(1:qts)) {
    amostras[[I]] <- slice_sample(df, n = N, replace = TRUE)
  }
  amostras
}

```

Agora com 10 amostras com $n = 30$; veja como os valores das amostras (pontos em azul) ocorrem em cada uma. É importante lembrar deste conceito quando falamos de uma amostra. 

```{r fig.height=20}
SSize <- 30
Qtde <- 10
amostrasN30 <- geraamostras(df, Qtde, SSize)
graficosN30 <- lapply(amostrasN30, FUN = function(x) geragrafs(g, x))

ggarrange(plotlist = graficosN30, nrow = 5, ncol = 2) %>%
  annotate_figure(top = text_grob(paste0("Experimento com ", Qtde, " amostras de tamanho = ", SSize), face = "bold", size = 16))
```

Observe como as médias das amostras variam; ora são maiores ora menores do que a média da população ($\mu = 3.4$). 

Para ilustrar um pouco mais os conceitos de amostragem, vamos selecionar novamente 10 amostras, mas agora de tamanho $n = 10$.

```{r fig.height=20}
SSize <- 10
Qtde <- 10
amostrasN10 <- geraamostras(df, Qtde, SSize)
graficosN10 <- lapply(amostrasN10, FUN = function(x) geragrafs(g, x))

ggarrange(plotlist = graficosN10, nrow = 5, ncol = 2) %>%
  annotate_figure(top = text_grob(paste0("Experimento com ", Qtde, " amostras de tamanho = ", SSize), face = "bold", size = 16))
```

Veja como em ambas as figuras, sempre temos uma maior concentração de pontos azuis na região próxima da média da população; isso ocorre porque temos um maior número de animais cujo peso está nessa região, isto é, peso próximo da média da população. Mas também temos animais com peso bem maior ou bem menor do que a média; eles são mais raros nas amostras, porque são mais raros também na população.





```{r}
set.seed(1234)
mediasamostrais <- function(amostra, N, SSize) {
  medias <- c()
  for (I in seq(1:N)) {
     amostra <- slice_sample(df, n = SSize, replace = TRUE)
     amostra$P0 <- 0
     pesomedioamostra = mean(amostra$`Peso(kg)`, na.rm = TRUE)
     medias[I] <- pesomedioamostra
  }
  return(medias)
}


```

```{r}
SSize <- 30
Qtde <- 1000
```

### Grande Número de Amostras

Vamos agora coletar `r Qtde` amostras de `r SSize` elementos; para cada amostra calculamos a média do peso dos animas e construímos um histograma com o respectivo gráfico de densidade de probabilidade, como mostrado na figura abaixo. Também calculamos a média das médias das amostras, que é mostrada na figura, juntamente com o intervalo de confiança de 95%.

```{r}
milamostras <- geraamostras(df, Qtde, SSize)
```

```{r}
mediasamostras <- sapply(milamostras, function(x) {
  mediaPeso <- mean(x$`Peso(kg)`, na.rm = TRUE)
  mediaPeso
}
)

mediasam_est <- t.test(mediasamostras)
mediasam_mean <- as.numeric(mediasam_est$estimate)
mediasam_confint <- as.numeric(mediasam_est$conf.int)

dfmedias <- tibble(x = mediasamostras)
ggplot(dfmedias, aes(x = x, after_stat(density))) + 
  geom_density() + 
  geom_histogram(alpha = 0.3) + 
  geom_segment(aes(x = mediasam_mean, y = 0, xend=mediasam_mean, yend = 0.15), 
                            color = "red", size = 0.15) +
  geom_segment(aes(x = mediasam_confint[1], y = 0, xend=mediasam_confint[1], yend = 0.15), 
                            color = "blue", size = 0.15) +
  geom_segment(aes(x = mediasam_confint[2], y = 0, xend=mediasam_confint[2], yend = 0.15), 
                            color = "blue", size = 0.15) +
 annotate("text", x = 1.003*mediasam_mean, y = 0.75, 
                        label = paste("Média das Médias Amostrais: \n",  round(mediasam_mean,3)), size = 3) +
 annotate("text", x = 0.993*mediasam_mean, y = 0.5, 
                        label = paste(" (%95 CI): [",  round(mediasam_confint[1],3), ",",
                                      round(mediasam_confint[2],3), "]"), size = 3) +
  labs(x = "Médias de Peso das Amostras (kg)", y = "Densid.Prob.") + 
  ggtitle(paste0("Experimento com ", Qtde, " amostras de tamanho n = ", SSize)) +
  theme_light()

```



```{r}
SSize <- 10
Qtde <- 1000
```


Se repetimos este experimento com `r Qtde` amostras, mas agora com `r SSize` elementos, obtemos o seguinte resultado:

```{r}
milamostrasSS10 <- geraamostras(df, Qtde, SSize)
```


```{r}
mediasamostrasSS10 <- sapply(milamostrasSS10, function(x) {
  mediaPeso <- mean(x$`Peso(kg)`, na.rm = TRUE)
  mediaPeso
}
)

mediasam_est <- t.test(mediasamostrasSS10)
mediasam_mean <- as.numeric(mediasam_est$estimate)
mediasam_confint <- as.numeric(mediasam_est$conf.int)

dfmediasSS10 <- tibble(x = mediasamostrasSS10)
ggplot(dfmediasSS10, aes(x = x, after_stat(density))) + 
  geom_density() + 
  geom_histogram(alpha = 0.3) + 
  geom_segment(aes(x = mediasam_mean, y = 0, xend=mediasam_mean, yend = 0.15), 
                            color = "red", size = 0.15) +
  geom_segment(aes(x = mediasam_confint[1], y = 0, xend=mediasam_confint[1], yend = 0.15), 
                            color = "blue", size = 0.15) +
  geom_segment(aes(x = mediasam_confint[2], y = 0, xend=mediasam_confint[2], yend = 0.15), 
                            color = "blue", size = 0.15) +
 annotate("text", x = 1.003*mediasam_mean, y = 0.75, 
                        label = paste("Média das Médias Amostrais: \n",  round(mediasam_mean,3)), size = 3) +
 annotate("text", x = 0.993*mediasam_mean, y = 0.5, 
                        label = paste(" (%95 CI): [",  round(mediasam_confint[1],3), ",",
                                      round(mediasam_confint[2],3), "]"), size = 3) +
  labs(x = "Médias de Peso das Amostras (kg)", y = "Densid.Prob.") + 
  ggtitle(paste0("Experimento com ", Qtde, " amostras de tamanho n = ", SSize)) +
  theme_light()

```



Como observamos nas figuras acima, a média das médias amostrais tende para a média verdadeira, $\mu$ = `r media`, quando tomamos um grande número de amostras.

Mas quando o biólogo seleciona uma amostra apenas de $n = 30$ animais, o peso médio dos animais desta amostra pode ser bem distante da média verdadeira, como ilustrado na figura abaixo, onde uma amostra tem peso médio bem abaixo e outra com peso médio bem acima da média verdadeira; e aí podemos perguntar: 

> Será que aconteceu alguma coisa que levou a uma diminuição ou aumento geral do peso destes animais (de toda a população) ou é apenas nesta amostra? 


```{r}
mediasamostrasSS30 <- sapply(amostrasN30, function(x) {
  mediaPeso <- mean(x$`Peso(kg)`, na.rm = TRUE)
  mediaPeso
}
)
menormedia <- which(mediasamostrasSS30 == min(mediasamostrasSS30))
maiormedia <- which(mediasamostrasSS30 == max(mediasamostrasSS30))
ggarrange(graficosN30[[menormedia]],graficosN30[[maiormedia]])
```


Para responder a esta pergunta podemos realizar o *Teste de Hipótese*.

Os passos para realizar o Teste de Hipótese, considerando um nível de significância $\alpha = 0.05$,  são:

1. Calcular a estatística de teste -- no caso, estatística $z$, porque **assumimos que nossos dados seguem uma distribuição normal** e conhecemos a média e o desvio padrão da população;
$$z = \frac{\bar{x} - \mu_0}{\textrm{desvio}/\sqrt{n}}$$
2. Calcular o valor crítico para o nível de significância definido;
$$z.alpha = qnorm(1 - alpha/2)$$
3. Verificar se o valor da estatística de teste está na *Região de Aceitação* ou na *Região Crítica ou de Rejeição*  da hipótese nula. Uma definição importante é se o teste é unilateral ou bilateral. Para esse exemplo, vamos considerar um teste **bilateral**, ou seja, queremos saber se o peso médio dos animais mudou.


### Teste de Hipótese


#### Amostra com menor média


```{r}
xbar <- min(mediasamostrasSS30)
n <- 30
alpha = 0.05
z <- (xbar - media)/(desvio/sqrt(n))
z.alpha <- qnorm(1 - alpha/2)
```


Os resultados dos cálculos são:

* media: `r media`
* desvio padrão: `r desvio`
* tamanho da amostra: `r n`
* $\bar{x}$: `r xbar`
* estatística z: `r z`
* valor crítico (limites da região - teste bilateral): `r c(-z.alpha, z.alpha)`

Então, o resultado do teste é:

```{r}
if(z > abs(z.alpha)) cat("Estatística de teste z está fora da região de aceitação, portanto rejeitamos a hipótese nula.") else cat("Estatística de teste z está dentro da região de aceitação, portanto aceitamos a hipótese nula.")
```


#### Amostra com maior média


```{r}
xbar <- max(mediasamostrasSS30)
n <- 30
alpha = 0.05
z <- (xbar - media)/(desvio/sqrt(n))
z.alpha <- qnorm(1 - alpha/2)
```


Os resultados dos cálculos são:

* media: `r media`
* desvio padrão: `r desvio`
* tamanho da amostra: `r n`
* $\bar{x}$: `r xbar`
* estatística z: `r z`
* valor crítico (limites da região - teste bilateral): `r c(-z.alpha, z.alpha)`

Então, o resultado do teste é:

```{r}
if(z > abs(z.alpha)) cat("Estatística de teste z está fora da região de aceitação, portanto rejeitamos a hipótese nula.") else cat("Estatística de teste z está dentro da região de aceitação, portanto aceitamos a hipótese nula.")
```


Observe que nós selecionamos as duas amostras acima da mesma população, mas mesmo assim, pelo Teste de Hipótese, uma delas,  a que tem peso médio maior, tem um peso médio que é considerado como oriundo de outra distribuição que não a original. 

> Quando realizamos um Teste de Hipótese estamos querendo verificar se a amostra analisada vem ou não da população original para a qual conhecemos os parâmetros. A média amostral será o valor utilizado na verificação.



<!-- 

É lógico que os animais do nosso exemplo não têm peso cuja média seja zero! E nem desvio padrão igual a 1. Então, porque a curva mostrada tem média = 0 e desvio padrão = 1?

É que estamos mostrando a distribuição normal padronizada, cuja área é igual a 1. Ou seja, a soma de todas as probabilidades deve ser 1.

Para transformar os valores de peso dos animais com esta restrição, usamos uma 
Essa técnica é chamada de normalização (ou padronização); consiste em transformar o valor original da variável, centrando-o em torno de uma das medidas de posição central (a média é uma delas) e mudando sua escala para uma das medidas de dispersão da distribuição (o desvio padrão é uma delas). 

Assim, os novos valores serão calculados como:
$$z = \frac{x_i - \bar{x}}{\sqrt(n)\times \sigma}$$

-->




## Populações ou Efeitos Modificadores

Continuando nosso exemplo da população de animais que estamos estudando, suponha agora que houve algum evento, ou fator, que tenha alterado o suprimento de alimento para os animais. Nessa situação, depois de algum tempo, pode ter havido uma *diminuição* do peso (massa corporal) destes animais.

```{r}
# adicionando um delta variável a cada valor de y para gerar a segunda população
#y2 <- df$`Peso(kg)` + runif(length(df$x),min = -.7, max = -.2)
media2 = 2.9
desvio2 = 0.8
tam = 8000
# gerando a segunda população da mesma maneira da original, i.e., especificando
# média e desvio padrão - vou usar este método
y2 <- rnorm(tam, mean = media2, sd = desvio2)
df$Pop <- "Original"
df2 <- bind_rows(tibble(x = df$x, `Peso(kg)` = y2, Pop = "Nova"), df)
```


Se fizéssemos um senso novamente, pesando todos os animas daquela população, poderíamos encontrar uma *nova distribuição de pesos*, gerando uma segunda curva, como mostrado na figura abaixo. Essa *nova população* tem média `r media2` e desvio padrão `r desvio2`.


```{r }
g <- ggplot(data = df2, aes(x = `Peso(kg)`, after_stat(density))) + 
  geom_density(aes(color = Pop), outline.type = "full") + 
  #geom_histogram(aes(fill = Pop), alpha = 0.3 ) +
  labs(x = "Peso(kg)", y = "Densid.Prob.") +
  theme_light() 
ggplotly(g  + ggtitle(paste("Distribuição dos pesos das populações (n=",tam,")")))
```

Como o desvio padrão desta nova distribuição é um pouco maior que da original, a curva de densidade de probabilidade é mais achatada (larga) e por isso, tem uma altura (máximo da densidade) menor.




